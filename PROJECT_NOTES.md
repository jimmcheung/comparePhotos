# PhotoCompare 项目需求与变更记录

## 1. 功能需求与设定

- **多图对比**：支持同时上传2-5张图片，进行细节对比。
- **同步缩放/平移**：任意图片的缩放、平移操作可同步到其他图片（可开关）。
- **EXIF 信息显示**：展示图片的相机型号、镜头、参数等EXIF信息。
- **深色/浅色主题切换**：支持主题切换。
- **演示模式**：全屏展示，适合录屏和演示。
- **响应式设计**：适配各种设备。
- **图片懒加载**：优化性能。
- **本地存储用户偏好**。
- **标注功能**（即将开发）：支持对图片进行矩形、圆形、画笔等标注，标注可编辑、删除、同步、导出。
  - 标注开关和同步开关仅在图片上传后出现。
  - 标注开关开启时可绘制，关闭时可拖动图片，绘制内容随图片移动缩放。
  - 同步开关开启时绘制同步到所有图片，关闭时仅当前图片。
  - 工具栏风格参考iPadOS备忘录，支持矩形、圆形、画笔、三种粗细、五种预设色、自定义调色板、清空。
  - 工具栏可拖动，带优雅动画，标注开关开启时显示，关闭时隐藏。
  - 绘制采用SVG，保证缩放清晰度。
  - 支持撤销/重做（快捷键实现，无需界面按钮）。
  - 支持移动端触控适配。
  - 标注可编辑，需有选中按钮，操作风格类似Figma。
- **标注工具栏美化与交互细节**（已实现 iPadOS 备忘录风格）
  - 工具栏为横向浮动，极大圆角（两端完整半圆），毛玻璃磨砂背景，柔和阴影。
  - 工具/粗细/颜色/清空分组横向排列，按钮更大更圆润。
  - 工具/颜色/粗细选中有高亮外圈和阴影，动画优雅。
  - 拖动区已去除，整个工具栏空白区域都可拖动。
  - 画笔icon为拟真毛笔/涂鸦风格，调色盘icon为色盘，选中后中间显示当前色。
  - 清空按钮为垃圾桶icon，风格统一，无红色文字。
  - 工具栏初始位置为页面正中心偏下。
  - 工具栏出现动画为向上浮现，关闭时为向下淡出，整体更有"浮现感"。
  - 工具栏背景为完整的超大圆角矩形，内容有足够内边距，按钮不贴边，整体悬浮感强。
  - "更多颜色"按钮点击后弹出独立的色板弹窗，支持色板选择和色值输入，弹窗风格与工具栏一致，定位在调色盘icon下方。

## 2. 重要修改与修复方向

- **EXIF信息丢失修复**：所有图片上传/添加都必须统一调用`processImageFile`，保证EXIF信息正确提取和显示。
- **ImageInfo类型结构统一**：全局加上`file?: File`字段，类型安全一致。
- **关于弹窗GitHub链接修正**：所有关于信息弹窗中的GitHub仓库链接需指向 https://github.com/jimmcheung/photoCompare。
- **版本号管理**：所有涉及版本号的地方（页面、弹窗、README等）需同步更新。
- **每次功能/修复都需同步更新README和更新日志**。

## 3. 你的开发意图与偏好

- 代码风格要求简洁、无冗余、全局一致。
- 修改时要全局考虑，不要只改单点。
- 需求和设定要有文档记录，方便AI或新开发者快速理解。

## 4. AI助手开发约束（全局约束）

1. **全局考虑**  
   每次代码修改都要考虑对整个项目的影响，不能只改单点，需保证全局一致性和兼容性。

2. **精简代码结构**  
   代码实现要简洁、清晰，避免重复和冗余，能复用的逻辑尽量复用。

3. **不影响其他功能**  
   新增或修改功能时，必须保证现有功能的正常运行，不引入回归bug。

4. **不破坏CSS样式和视觉效果**  
   所有UI相关修改都要保证页面视觉风格、布局、响应式和交互体验不被破坏。

5. **不造成冗余功能和冗余代码**  
   禁止引入无用的功能、变量、组件、样式等，保持项目整洁。

## 3. 未来优化与待办事项

- **移动端标注体验优化**（待实现）
  - 标注绘制、选中、拖动、删除等操作在移动端（触摸屏）下流畅可用。
  - 工具栏、SVG 标注层、交互区域响应式适配。
  - 触摸事件兼容 pointer 事件，支持手指绘制和拖动标注。
  - 防止页面滚动穿透、误触、工具栏遮挡等。
  - 测试 iOS/Android 下的绘制、拖动、删除等操作流畅性，必要时增加兼容性处理。

### 2024-06-XX 标注同步与动画体验优化补充

- 同步标注模式下，采用全局唯一drawing状态，所有图片都渲染同一个物理坐标的drawing，pointer事件只在发起绘制的图片上处理，所有图片都能实时看到同一物理位置的绘制过程和结果。坐标换算、缩放、平移、标注等均以图片原始像素为基准，保证对比体验极致。优化结构不影响其他功能。
- 工具栏动画需严格保证出现时向上浮现、消失时向下淡出，动画完整播放后再卸载。
- 以上所有细节优化、交互修复、视觉统一等，均需全局考虑、结构精简、对标高标准，严格按AI开发约束推进。

### 2024-06-XX 标注工具栏与交互体验升级

1. 工具栏视觉与交互优化
   - 工具栏整体风格更现代，分组清晰，圆角、阴影、动画体验优化。
   - 工具栏初始位置居中偏下，支持拖动，拖动后记忆位置。
   - 工具栏所有按钮均为正圆，icon大小统一，内容居中。
   - 清空按钮初始无红色外圈，仅在 hover/focus 时显示红色高亮。

2. 颜色选择与弹窗
   - 预置颜色按钮中间的颜色圆形放大为25px，视觉更突出。
   - "更多颜色"按钮 icon 更换为极简色轮（SVG），尺寸可调，视觉更美观。
   - "更多颜色"弹窗用 Portal 渲染，定位更智能，优先显示在按钮上方，间距可调，始终可见。
   - 弹窗内可用色板和输入色值，选中后 customColor 和 annotationColor 同步。
   - 色板弹窗拖动选色时不会再误触发工具栏拖动，体验更自然。

3. 线宽选择全新交互
   - 线宽选择由多个按钮改为一个按钮，点击后弹出纵向排列的线宽菜单（Portal弹窗）。
   - 线宽菜单弹窗圆角加大（25px），风格与色板弹窗一致。
   - 线宽icon由不同粗细的正弦波SVG表示，振幅固定，所有线宽视觉统一。
   - 线宽icon默认黑色，hover/选中时为蓝色，按钮默认无外圈，hover/选中时显示高亮外圈。
   - 线宽菜单支持点击外部自动关闭，交互体验与下拉菜单一致。

4. 默认状态与交互细节
   - 开启标注时，默认颜色为红色（#FF3B30），线宽为中间值（4）。
   - 工具栏所有交互细节、视觉高亮、动画均与iPadOS备忘录风格对齐。
   - 代码结构更精简，所有弹窗均用 Portal 渲染，彻底避免父级样式干扰。

5. 体验与兼容性
   - 交互体验高度专业化，所有细节均有文档记录。
   - 代码结构精简，易于维护和扩展。
   - 兼容主流浏览器，移动端适配良好。

- 预置颜色按钮icon需为正圆，视觉统一。
- 点击"更多颜色"icon应弹出色盘弹窗。
- 清空按钮icon需为圆形外圈风格。
- 工具按钮（矩形、圆形、画笔、粗细）选中高亮时，图形需为统一大小的圆形。
- 绘制时，正在绘制的图形不能闪烁，需流畅。
- 关闭标注后应恢复图片拖动。
- 图片与绘制内容缩放需完全同步，不能有缓动差异。
- 以上所有细节优化、交互修复、视觉统一等，均需全局考虑、结构精简、对标高标准，不影响其他功能，严格按AI开发约束推进。

### 2024-06-XX 同步缩放/同步标注统一开关方案

- 设计决策：界面只保留一个"同步"开关（syncZoom），用户无需区分"同步缩放"和"同步标注"，极简体验。
- 技术实现：
  - 移除 annotationStore 中的 isSyncAnnotate/setSyncAnnotate 字段及相关逻辑。
  - ImageViewer 及所有同步相关逻辑全部依赖 useSettingsStore 的 syncZoom 状态。
  - 只要 syncZoom 开启，图片的缩放、平移、标注绘制都同步；关闭则全部独立。
- 优点：
  - 用户界面极简，只有一个同步开关。
  - 代码结构更清晰，所有同步相关逻辑都依赖同一个全局状态。
  - 满足"同步"开关一键控制所有同步体验的需求。

### 2024-06-XX 色板弹窗拖动冲突修复

- 问题：色板弹窗拖动选色时会导致整个工具栏一起拖动，严重影响体验。
- 原因：工具栏拖动监听了整个区域的 pointerdown，色板弹窗事件冒泡导致误触发。
- 解决方案：在色板弹窗根节点加 onPointerDown={e => e.stopPropagation()}，彻底阻止事件冒泡，保证色板拖动与工具栏拖动互不干扰。
- 优点：实现极简，结构清晰，不影响其他功能和交互。

### 2024-06-XX 标记（标注）功能设计与交互细节

1. 工具栏与标注工具
   - 工具栏初始位置：页面居中偏下，支持任意方向拖动，拖动后记忆位置。
   - 工具栏分组：形状（矩形、圆形、画笔）、线宽、颜色、清空，分割线明显。
   - 所有按钮：正圆，icon大小统一，内容居中，视觉呼吸感强。
   - 按钮高亮：选中时有高亮外圈，hover时有浅色外圈，未选中无外圈。
   - 清空按钮：初始无红色外圈，仅hover/focus时显示红色高亮。

2. 标注形状与线宽
   - 支持形状：矩形、圆形、自由画笔。
   - 线宽选择：单按钮，点击弹出纵向菜单，三种线宽（2/4/8），icon为正弦波SVG，振幅固定，线宽不同视觉统一。
   - 线宽icon：默认黑色，hover/选中为蓝色，按钮默认无外圈，hover/选中时显示高亮外圈。
   - 线宽菜单：圆角25px，点击外部自动关闭。

3. 颜色选择
   - 预置颜色：红、黄、蓝，按钮中间色块为25px正圆。
   - 更多颜色：极简色轮SVG icon，尺寸可调，icon中间显示当前自定义色。
   - 色板弹窗：Portal渲染，优先显示在按钮上方，间距可调，始终可见。
   - 弹窗内容：色板+色值输入，选中后customColor和annotationColor同步。
   - 弹窗交互：拖动选色时不会误触发工具栏拖动，点击外部自动关闭。

4. 标注绘制与交互
   - 默认状态：开启标注时，默认颜色为红色（#FF3B30），线宽为中间值（4）。
   - 标注绘制：SVG实现，缩放时不失真，绘制流畅无闪烁。
   - 标注同步：同步开关控制所有图片的标注同步，关闭时各自独立。
   - 标注选中：点击标注后高亮显示，选中有高亮外圈。
   - 标注编辑：支持选中、拖动、删除，操作风格类似Figma。
   - 标注撤销/重做：支持快捷键撤销/重做，无需界面按钮。
   - 标注清空：点击清空按钮可一键删除所有标注。

5. 状态切换与视觉反馈
   - 工具栏出现/消失：带有向上浮现/向下淡出动画，动画完整播放后再卸载DOM。
   - 按钮状态：点击前无高亮，点击后高亮，hover时有浅色外圈，focus时同hover。
   - 颜色/线宽/形状切换：切换后按钮高亮，icon同步变化。
   - 清空按钮：hover/focus时显示红色高亮外圈，未选中无外圈。

6. 位置、大小、颜色等细节
   - 工具栏：高度72px，宽度自适应内容，极大圆角（999px），毛玻璃背景，阴影柔和。
   - 按钮：40×40px正圆，icon居中，内容不贴边。
   - 分割线：高度36px，宽1.5px，颜色rgba(120,120,140,0.18)，分组明显。
   - 色板弹窗：宽220px，圆角18px阴影柔和，内容居中。
   - 线宽菜单：宽48px，圆角25px，纵向排列，按钮32×32px。
   - 标注颜色：预置红#FF3B30、黄#FFD60A、蓝#007AFF，自定义色支持任意HEX。
   - 标注线宽：2/4/8三档，icon为正弦波，振幅固定，线宽不同视觉统一。

7. 其他体验细节
   - 所有弹窗均用Portal渲染，彻底避免父级样式干扰。
   - 所有交互细节、视觉高亮、动画均与iPadOS备忘录风格对齐。
   - 代码结构精简，易于维护和扩展。
   - 兼容主流浏览器，移动端适配良好。

---

> 本文档会随着你的新需求、设定、开发原则自动补充和更新，任何AI助手或开发者只需阅读本文件即可快速理解你的开发意图和项目历史。 